workflows:
  # Pull Request Validation
  pr-validation:
    name: PR Validation
    instance_type: mac_mini_m2
    max_build_duration: 20
    environment:
      flutter: fvm
    when:
      changeset:
        includes:
          - "apps/**"
          - "packages/**"
          - "melos.yaml"
          - "codemagic.yaml"
          - "pubspec.yaml"
        excludes:
          - "**/*.md"
          - "**/README.md"
          - "docs/**"
    triggering:
      events:
        - pull_request
      branch_patterns:
        - pattern: "main"
          include: true
          source: false
    cache:
      cache_paths:
        - ~/.pub-cache
        - $FLUTTER_ROOT/.pub-cache
    scripts:
      - name: Setup Environment
        script: |
          echo "Setting up Dart/Flutter environment..."
          echo PATH="$PATH":"$FLUTTER_ROOT/.pub-cache/bin" >> $CM_ENV
          echo PATH="$PATH":"$FLUTTER_ROOT/bin" >> $CM_ENV
          dart --version
          flutter --version

      - name: Install Melos
        script: |
          echo "Installing Melos..."
          dart pub global activate melos
          melos --version

      - name: Bootstrap Monorepo
        script: |
          echo "Bootstrapping monorepo packages..."
          melos bootstrap --verbose

      - name: Generate
        script: |
          echo "Running generations..."
          melos generate
          melos localization

      - name: Run Full Validation
        script: |
          echo "Running full validation pipeline..."
          melos analyze
          melos test
          melos format:check

    artifacts:
      - coverage/**/*.html
      - "**/coverage/lcov.info"
      - "**/build/app/outputs/flutter-apk/*.apk"

  # Main Branch CI/CD
  main-ci:
    name: Main Branch CI/CD
    instance_type: mac_mini_m2
    max_build_duration: 30
    environment:
      flutter: fvm
    when:
      changeset:
        includes:
          - "apps/**"
          - "packages/**"
          - "melos.yaml"
          - "codemagic.yaml"
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "main"
          include: true
        - pattern: "develop"
          include: true
    cache:
      cache_paths:
        - ~/.pub-cache
        - $FLUTTER_ROOT/.pub-cache
    scripts:
      - name: Setup Environment
        script: |
          echo "Setting up production environment..."
          echo PATH="$PATH":"$FLUTTER_ROOT/.pub-cache/bin" >> $CM_ENV
          echo PATH="$PATH":"$FLUTTER_ROOT/bin" >> $CM_ENV

      - name: Install Melos
        script: |
          dart pub global activate melos
          melos --version

      - name: Bootstrap Monorepo
        script: |
          melos bootstrap --verbose

      - name: Generate
        script: |
          echo "Running generations..."
          melos generate
          melos localization

      - name: Run Full Validation
        script: |
          echo "Running full validation pipeline..."
          melos analyze
          melos test
          melos format:check

    artifacts:
      - "**/build/app/outputs/flutter-apk/*.apk"
      - "**/build/web/**"
      - coverage/**/*.html